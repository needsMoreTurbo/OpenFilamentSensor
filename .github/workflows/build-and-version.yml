name: Build & Release Firmware

on:
  push:
    tags:
      - 'v*'           # build on version tags
    branches:
      - main
      - dev
  workflow_dispatch:

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        run: sudo apt-get update && sudo apt-get install -y g++

      - name: Run simulator suite
        run: |
          cd test
          bash build_tests.sh

  matrix-source:
    runs-on: ubuntu-latest
    outputs:
      board-matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - id: set-matrix
        run: |
          MATRIX=$(python - <<'PY'
          import json, yaml
          with open('tools/build-targets.yml', 'r', encoding='utf-8') as f:
              data = yaml.safe_load(f)
          matrix = {'env': data.get('platformio_envs', [])}
          print(json.dumps(matrix))
          PY
          )
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build:
    needs: [unit-tests, matrix-source]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.matrix-source.outputs.board-matrix) }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install PlatformIO core
        run: pip install platformio

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Lite UI deps
        working-directory: webui_lite
        run: npm ci

      - name: Generate build timestamp
        id: timestamp
        run: echo "datetime=$(date -u +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: Build firmware + filesystem for ${{ matrix.env }}
        run: |
          python tools/build_and_flash.py --env ${{ matrix.env }} --local --ignore-secrets

      - name: Collect merged image
        run: |
          BUILD_DIR=.pio/build/${{ matrix.env }}
          BUILD_DATETIME=${{ steps.timestamp.outputs.datetime }}
          mkdir -p artifacts/${{ matrix.env }}
          cp $BUILD_DIR/firmware.bin artifacts/${{ matrix.env }}/firmware_${BUILD_DATETIME}.bin
          cp $BUILD_DIR/littlefs.bin artifacts/${{ matrix.env }}/littlefs_${BUILD_DATETIME}.bin
          cp $BUILD_DIR/firmware_merged.bin artifacts/${{ matrix.env }}/firmware_merged_${BUILD_DATETIME}.bin

      - uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.env }}-${{ steps.timestamp.outputs.datetime }}
          path: artifacts/${{ matrix.env }}

