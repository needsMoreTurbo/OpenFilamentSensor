name: Dev Smoke Test

on:
  pull_request:
    branches:
      - dev
  push:
    branches:
      - zzdev
  workflow_dispatch:

jobs:
  tests:
    name: Run test suite
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York
    steps:
      - uses: actions/checkout@v4

      - name: Install g++
        run: |
          sudo apt-get update
          sudo apt-get install -y g++

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run all unit tests
        working-directory: test
        run: |
          chmod +x build_and_run_all_tests.sh
          bash build_and_run_all_tests.sh

  build-s3:
    name: Build esp32s3 firmware
    if: github.event_name == 'workflow_dispatch'
    needs: tests
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO Core
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Lite UI deps
        working-directory: webui_lite
        run: npm ci

      - name: Generate build timestamp
        id: timestamp
        run: echo "datetime=$(date -u +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: Create version files
        shell: bash
        run: |
          VERSION="dev-${{ github.run_number }}"
          mkdir -p data
          echo "$VERSION" > data/build_version.txt
          date -u +%m%d%y%H%M%S > data/build_timestamp.txt
          echo "$VERSION" > data/.version

      - name: Build firmware + filesystem for esp32s3
        env:
          FIRMWARE_VERSION: dev
        run: |
          python tools/build_and_flash.py --env esp32s3 --local --ignore-secrets

      - name: Collect artifacts
        run: |
          BUILD_DIR=.pio/build/esp32s3
          BUILD_DATETIME=${{ steps.timestamp.outputs.datetime }}
          mkdir -p artifacts/esp32s3
          cp $BUILD_DIR/firmware.bin artifacts/esp32s3/firmware_${BUILD_DATETIME}.bin
          cp $BUILD_DIR/littlefs.bin artifacts/esp32s3/littlefs_${BUILD_DATETIME}.bin
          cp $BUILD_DIR/firmware_merged.bin artifacts/esp32s3/firmware_merged_${BUILD_DATETIME}.bin

      - uses: actions/upload-artifact@v4
        with:
          name: firmware-esp32s3-${{ steps.timestamp.outputs.datetime }}
          path: artifacts/esp32s3
