name: Release Firmware

on:
  push:
    tags:
      - 'v*'           # Build on version tags (e.g., v1.0.0, v1.2.3)
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

jobs:
  matrix-source:
    runs-on: ubuntu-latest
    outputs:
      board-matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - id: set-matrix
        run: |
          MATRIX=$(python - <<'PY'
          import json, yaml
          with open('tools/build-targets.yml', 'r', encoding='utf-8') as f:
              data = yaml.safe_load(f)
          matrix = {'env': data.get('platformio_envs', [])}
          print(json.dumps(matrix))
          PY
          )
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build:
    needs: matrix-source
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.matrix-source.outputs.board-matrix) }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install PlatformIO core
        run: pip install platformio

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Lite UI deps
        working-directory: webui_lite
        run: npm ci

      - name: Generate build timestamp
        id: timestamp
        run: echo "datetime=$(date -u +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: Build firmware + filesystem for ${{ matrix.env }}
        run: |
          python tools/build_and_flash.py --env ${{ matrix.env }} --local --ignore-secrets

      - name: Collect artifacts
        run: |
          BUILD_DIR=.pio/build/${{ matrix.env }}
          BUILD_DATETIME=${{ steps.timestamp.outputs.datetime }}
          mkdir -p release-artifacts/${{ matrix.env }}

          # Copy firmware files with descriptive names
          # Use individual files for reliable web flashing
          cp $BUILD_DIR/firmware.bin release-artifacts/${{ matrix.env }}/centauri-${{ matrix.env }}-firmware-${BUILD_DATETIME}.bin
          cp $BUILD_DIR/bootloader.bin release-artifacts/${{ matrix.env }}/centauri-${{ matrix.env }}-bootloader-${BUILD_DATETIME}.bin
          cp $BUILD_DIR/partitions.bin release-artifacts/${{ matrix.env }}/centauri-${{ matrix.env }}-partitions-${BUILD_DATETIME}.bin
          cp $BUILD_DIR/littlefs.bin release-artifacts/${{ matrix.env }}/centauri-${{ matrix.env }}-littlefs-${BUILD_DATETIME}.bin

          # Include merged firmware for advanced users (may not work with web flasher)
          cp $BUILD_DIR/firmware_merged.bin release-artifacts/${{ matrix.env }}/centauri-${{ matrix.env }}-firmware-merged-${BUILD_DATETIME}.bin

      - uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.env }}-${{ steps.timestamp.outputs.datetime }}
          path: release-artifacts/${{ matrix.env }}
          retention-days: 30

  create-release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Flatten all artifacts into release-assets directory
          find ./all-artifacts -name "*.bin" -exec cp {} ./release-assets/ \;

          # Create a checksum file
          cd release-assets
          sha256sum *.bin > checksums.txt

          # List what we're releasing
          echo "Release assets prepared:"
          ls -la *.bin checksums.txt

      - name: Extract release notes
        id: release-info
        run: |
          if [[ ${{ github.ref_type }} == 'tag' ]]; then
            VERSION=${{ github.ref_name }}
          else
            VERSION=${{ github.event.inputs.version }}
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Get commit message for tag (if available)
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-info.outputs.version }}
          name: "Centauri Firmware ${{ steps.release-info.outputs.version }}"
          body: |
            ## Centauri Carbon Motion Detector Firmware Release ${{ steps.release-info.outputs.version }}

            ${{ steps.release-info.outputs.message }}

            ### üì¶ What's Included

            This release includes firmware binaries for all supported board variants:

            #### üéØ Supported Boards
            - **ESP32-S3 Dev**: `esp32-s3-dev` - Main development board
            - **Seeed XIAO ESP32-C3**: `seeed_xiao_esp32c3-dev` - Compact C3 board

            #### üìÅ File Naming Convention
            - `centauri-{board}-{type}-{timestamp}.bin`
            - Types: `firmware`, `littlefs`, `firmware-merged`, `bootloader`, `partitions`
            - Example: `centauri-esp32-s3-dev-firmware-merged-20241129_143022.bin`

            #### üöÄ Flashing Instructions

            **Option 1: Web Flashing (Recommended)**
            1. Visit the distributor site: **[https://your-org.github.io/centauri-carbon-motion-detector](https://your-org.github.io/centauri-carbon-motion-detector)**
            2. Select your board variant
            3. Click "Flash firmware" and follow the prompts

            **Option 2: Manual Flashing**
            1. Download the `firmware-merged.bin` for your board
            2. Use esptool.py to flash: `esptool.py write_flash 0x0 centauri-{board}-firmware-merged-{timestamp}.bin`

            #### üîß Board-Specific Notes
            - **ESP32-S3**: Use the merged firmware binary for easiest flashing
            - **ESP32-C3**: Requires external UART bridge for manual flashing

            #### ‚ö†Ô∏è Important
            - Always backup your current firmware before updating
            - Ensure your board matches the selected variant
            - Flash with correct offset (typically 0x0 for merged binaries)

            ---
            ### üìã File Integrity
            Verify file integrity with the provided SHA256 checksums.

            ü§ñ *This release was automatically built and published.*

          files: release-assets/*
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || 'false' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}