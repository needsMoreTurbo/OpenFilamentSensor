name: Release Firmware

on:
  push:
    tags:
      - 'v*' # Triggers on tags like v1.0, v2.3.4

permissions:
  contents: write # Required for softprops/action-gh-release to create a release
  actions: read   # Required for the branch check
  pull-requests: read # Required for softprops/action-gh-release

jobs:
  build-firmware:
    name: Build ${{ matrix.env }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # All build environments from platformio.ini
        env: [esp32, esp32s3, seeed_esp32s3, seeed_esp32c3, esp32c3, esp32c3supermini, esp32s2]
    # This condition ensures the job only runs for tags on the 'build' branch.
    if: >
      github.event_name == 'push' &&
      startsWith(github.ref, 'refs/tags/') &&
      github.run_id != '' &&
      fromJSON(needs.check-branch.outputs.result).conclusion == 'success'
    needs: check-branch
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for git tags

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install PlatformIO Core
        run: pip install platformio

      - name: Get Version from Tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build target
        env:
          FIRMWARE_VERSION: ${{ steps.get_version.outputs.VERSION }}
        run: |
          pio run -e ${{ matrix.env }}

      - name: Prepare build artifact
        run: |
          ARTIFACT_DIR="release-assets-${{ matrix.env }}"
          mkdir -p "$ARTIFACT_DIR"
          python - <<'PY'
          import shutil
          from pathlib import Path
          import os

          env = os.environ["MATRIX_ENV"]
          artifact_dir = Path(f"release-assets-{env}")
          build_dir = Path(".pio") / "build" / env

          filenames = ["firmware.bin", "firmware_merged.bin", "littlefs.bin", "bootloader.bin", "partitions.bin"]

          for name in filenames:
              src = build_dir / name
              if src.exists():
                  dest_name = f"{env}-{name}"
                  shutil.copy2(src, artifact_dir / dest_name)
          PY
        env:
          MATRIX_ENV: ${{ matrix.env }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.env }}
          path: release-assets-${{ matrix.env }}

  check-branch:
    name: Verify Tag on Build Branch
    runs-on: ubuntu-latest
    # This job always runs on a tag push to check the branch.
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    outputs:
      result: ${{ steps.check.outputs.result }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history to check branches

      - name: Check if tag is on 'build' branch
        id: check
        run: |
          # This command checks if the commit for the current tag is an ancestor of the 'build' branch.
          # It exits with 0 (success) if it is, and 1 (failure) if it is not.
          if git merge-base --is-ancestor ${{ github.sha }} origin/build; then
            echo "Tag ${{ github.ref_name }} is on the 'build' branch. Proceeding with release."
            echo "result={\"conclusion\":\"success\"}" >> $GITHUB_OUTPUT
          else
            echo "Tag ${{ github.ref_name }} is not on the 'build' branch. Skipping release."
            echo "To release, create the tag on a commit in the 'build' branch."
            echo "result={\"conclusion\":\"skipped\"}" >> $GITHUB_OUTPUT
          fi

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-firmware # This job runs after all builds are complete
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Version from Tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-release-assets

      - name: Collate artifacts and create checksums
        run: |
          mkdir release-assets
          find all-release-assets -type f -name "*.bin" -exec mv {} release-assets/ \;
          ls -l release-assets
          (cd release-assets && sha256sum *.bin > checksums.txt)

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Generates release notes from commits between this tag and the previous one.
          # For the very first tag, it lists all commits.
          PREVIOUS_TAG=$(git tag --sort=-v:refname | sed -n '2p' 2>/dev/null)
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          git log --pretty=format:"* %s (%h)" $PREVIOUS_TAG..${{ steps.get_version.outputs.VERSION }} >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: "Centauri Firmware ${{ steps.get_version.outputs.VERSION }}"
          body: |
            ## Firmware Release ${{ steps.get_version.outputs.VERSION }}

            ### Changelog
            ${{ steps.release_notes.outputs.CHANGELOG }}

            ### Included artifacts
            - All supported boards
            - `checksums.txt` with SHA256 digests
          files: release-assets/*
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
