name: Release Firmware

on:
  push:
    tags:
      - 'zzv*'
  pull_request:
    branches:
      - zzbuild
      - zzmain
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Optional version to embed (e.g., 1.2.3-test). If empty on manual runs, a dev placeholder is used.'
        required: false
        default: ''

permissions:
  contents: write
  actions: read
  pull-requests: read

jobs:
  tests:
    name: Run full test suite
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York
    if: github.event_name != 'pull_request' || github.base_ref == 'build' || github.event.pull_request.head.ref == 'dev'
    steps:
      - uses: actions/checkout@v4

      - name: Install g++
        run: |
          sudo apt-get update
          sudo apt-get install -y g++

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run all build tests
        working-directory: test
        run: |
          chmod +x build_and_run_all_tests.sh
          bash build_and_run_all_tests.sh

  matrix-source:
    name: Determine build matrix
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York
    if: github.event_name != 'pull_request' || github.base_ref == 'build' || github.event.pull_request.head.ref == 'dev'
    outputs:
      board-matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Load PlatformIO environments from tools/build-targets.yml
        id: set-matrix
        run: |
          MATRIX=$(python - << 'PY'
          import json
          import yaml
          from pathlib import Path

          with Path("tools/build-targets.yml").open("r", encoding="utf-8") as f:
              data = yaml.safe_load(f) or {}

          matrix = {"env": data.get("platformio_envs", [])}
          print(json.dumps(matrix))
          PY
          )
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  build-firmware:
    name: Build firmware for ${{ matrix.env }}
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York
    needs: [matrix-source, tests]
    if: github.event_name != 'pull_request' || github.base_ref == 'build' || github.event.pull_request.head.ref == 'dev'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.matrix-source.outputs.board-matrix) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO Core
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Lite UI dependencies
        working-directory: webui_lite
        run: npm ci

      - name: Determine firmware version
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ github.base_ref }}" = "build" ]; then
              VERSION="0.0.0-pr-build-${{ github.event.number }}"
            else
              VERSION="0.0.0-pr-main-${{ github.event.number }}"
            fi
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.version_override }}" ]; then
              VERSION="${{ github.event.inputs.version_override }}"
            else
              VERSION="0.0.0-dev"
            fi
          else
            REF="${GITHUB_REF#refs/tags/}"
            VERSION="${REF#v}"
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Resolve chip family
        id: chip
        env:
          BOARD_ENV: ${{ matrix.env }}
        run: |
          CHIP=$(python - << 'PY'
          import os
          import sys
          from pathlib import Path

          sys.path.insert(0, str(Path("tools").resolve()))
          from board_config import get_chip_family_for_board

          env = os.environ["BOARD_ENV"]
          print(get_chip_family_for_board(env))
          PY
          )
          echo "family=$CHIP" >> "$GITHUB_OUTPUT"

      - name: Sanitize user settings (WiFi/IP)
        shell: bash
        run: |
          PLACEHOLDER="PLACEHOLDER_WIFI_STRING_32_CHARS"
          if [ -f "data/user_settings.json" ]; then
            python - <<'PY'
          import json
          from pathlib import Path
          
          PLACEHOLDER = "PLACEHOLDER_WIFI_STRING_32_CHARS"
          path = Path("data/user_settings.json")
          try:
              raw = path.read_text(encoding="utf-8")
              data = json.loads(raw or "{}")
          except Exception:
              data = {}
          
          # Normalize WiFi credentials to placeholder and set a safe placeholder IP
          if "ssid" in data:
              data["ssid"] = PLACEHOLDER
          if "passwd" in data:
              data["passwd"] = PLACEHOLDER
          if "elegooip" in data:
              data["elegooip"] = "1.1.1.1"
          
          path.write_text(json.dumps(data, indent=2) + "\n", encoding="utf-8")
          PY
          fi

      - name: Create version files
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          mkdir -p data
          echo "$VERSION" > data/build_version.txt
          echo "$(date +%m%d%y%H%M%S)" > data/build_timestamp.txt
          echo "$VERSION" > data/.version

      - name: Build firmware + filesystem for ${{ matrix.env }}
        env:
          FIRMWARE_VERSION: ${{ steps.get_version.outputs.VERSION }}
          CHIP_FAMILY: ${{ steps.chip.outputs.family }}
        run: |
          python tools/build_and_flash.py --env ${{ matrix.env }} --local --ignore-secrets

      - name: Collect build artifacts
        shell: bash
        run: |
          BUILD_DIR=".pio/build/${{ matrix.env }}"
          ARTIFACT_DIR="release-assets-${{ matrix.env }}"
          mkdir -p "$ARTIFACT_DIR"

          for name in firmware.bin firmware_merged.bin littlefs.bin bootloader.bin partitions.bin; do
            if [ -f "$BUILD_DIR/$name" ]; then
              cp "$BUILD_DIR/$name" "$ARTIFACT_DIR/${{ matrix.env }}-$name"
            fi
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.env }}
          path: release-assets-${{ matrix.env }}

  check-main-tag:
    name: Verify tag is on main
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York
      VERSION_OVERRIDE: ${{ github.event.inputs.version_override }}
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
    outputs:
      is_main: ${{ steps.check.outputs.is_main }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if tag commit is on main
        id: check
        shell: bash
        run: |
          set -euo pipefail

          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            # Use the manually entered version to form the tag name
            if [ -z "${VERSION_OVERRIDE}" ]; then
              echo "No version_override provided; treating as not on main."
              echo "is_main=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            RAW="${VERSION_OVERRIDE#v}"      # strip leading 'v' if present
            TAG="v${RAW}"

            git fetch origin --tags

            if ! git rev-parse "refs/tags/${TAG}" >/dev/null 2>&1; then
              echo "Tag '${TAG}' does not exist."
              echo "is_main=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            TARGET_SHA="$(git rev-parse "refs/tags/${TAG}")"
          else
            # Tag-push case: keep existing behavior (use the pushed commit)
            TAG="${GITHUB_REF#refs/tags/}"
            echo "Checking pushed tag: ${TAG}"
            TARGET_SHA="${GITHUB_SHA}"
          fi

          # Common check: is the tag commit on origin/main?
          git fetch origin main
          if git merge-base --is-ancestor "${TARGET_SHA}" origin/main; then
            echo "Tag commit is on main."
            echo "is_main=true" >> "$GITHUB_OUTPUT"
          else
            echo "Tag commit is NOT on main."
            echo "is_main=false" >> "$GITHUB_OUTPUT"
          fi

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York
    needs: [build-firmware, check-main-tag]
    if: (github.event_name == 'workflow_dispatch' && needs.check-main-tag.outputs.is_main == 'true') || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && needs.check-main-tag.outputs.is_main == 'true')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve version for release
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.version_override }}" ]; then
              VERSION="${{ github.event.inputs.version_override }}"
            else
              VERSION="0.0.0-dev"
            fi
            TAG="v${VERSION}"
          else
            RAW_REF="${GITHUB_REF#refs/tags/}"
            TAG="$RAW_REF"
            VERSION="${RAW_REF#v}"
          fi
          echo "TAG=$TAG" >> "$GITHUB_OUTPUT"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-release-assets

      - name: Collate artifacts and create checksums
        shell: bash
        run: |
          mkdir release-assets
          find all-release-assets -type f -name "*.bin" -exec mv {} release-assets/ \;
          ls -l release-assets
          (cd release-assets && sha256sum *.bin > checksums.txt)

      - name: Stage firmware assets for GitHub Pages
        shell: bash
        run: |
          RAW_TAG="${{ steps.get_version.outputs.TAG }}"
          STRIPPED="$(echo "$RAW_TAG" | sed -E 's/^v+//I')"
          NORMALIZED_TAG="v${STRIPPED}"
          echo "Normalizing tag '$RAW_TAG' -> '$NORMALIZED_TAG' for Pages path"
          PAGES_DIR="pages-publish/releases/${NORMALIZED_TAG}"
          mkdir -p "${PAGES_DIR}"
          cp -v release-assets/* "${PAGES_DIR}/"

      - name: Publish assets to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: pages-publish
          keep_files: true
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com

      - name: Generate Release Notes
        id: release_notes
        shell: bash
        run: |
          PREVIOUS_TAG=$(git tag --sort=-v:refname | sed -n '2p' 2>/dev/null)
          if [ -z "$PREVIOUS_TAG" ]; then
            # Take only a single root commit if multiple exist
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD | tail -n 1)
          fi

          echo "CHANGELOG<<EOF" >> "$GITHUB_OUTPUT"
          git log --pretty=format:"* %s (%h)" "$PREVIOUS_TAG"..${{ github.ref_name }} >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.TAG }}
          name: "OpenFilamentSensor Firmware ${{ steps.get_version.outputs.VERSION }}"
          body: |
            ## Firmware Release ${{ steps.get_version.outputs.VERSION }}

            ### Changelog
            ${{ steps.release_notes.outputs.CHANGELOG }}

            ### Included artifacts
            - All supported boards
            - `checksums.txt` with SHA256 digests
          files: release-assets/*
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}